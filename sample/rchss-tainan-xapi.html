<html>
    <head>
        <title>台南百年地圖</title>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="./leaflet-osm.js"></script>
        <script src="../lib/rchss.js"></script>
        <style>
        body, html { height: 100%; }
        #map { height: 100%; width:100% }
        </style>
    </head>
    <body>
<div id="map"></div>
<script type='text/javascript'>
var mkmap, osm, mapnames, maps, overlayMaps, i$, len$, e, k, m, map, find_elements, try_add_element, mk_marker;
mkmap = function(it){
  return new L.RCHSS[it]({
    opacity: 0.65
  });
};
osm = new L.OSM.Mapnik;
mapnames = ['Tainan_1875', 'Tainan_1875B', 'Tainan_1895', 'Tainan_1895c', 'Tainan_1896', 'Tainan_1900', 'JM20K_1904', 'Tainan_1907B', 'Tainan_1911', 'Tainan_1915', 'Tainan_1918', 'Tainan_1920', 'Tainan_1924', 'Tainan_1935', 'Tainan_1936', 'Tainan_1939', 'Tainan_1945', 'AMCityPlan_1945', 'Tainan_1946', 'Tainan_1951', 'Tainan_1959', 'Tainan_1971', 'Tainan_1974', 'Tainan_1982', 'Tainan_1984', 'Tainan_1986'];
maps = {};
overlayMaps = {};
for (i$ = 0, len$ = mapnames.length; i$ < len$; ++i$) {
  e = mapnames[i$];
  maps[e.toLowerCase()] = mkmap(e);
}
for (k in maps) {
  m = maps[k];
  overlayMaps[m.name] = m;
}

var xdata = new L.OSM.DataLayer();
map = new L.Map('map', {
  center: new L.LatLng(22.9920289, 120.20462829999997),
  zoom: 15,
  layers: [osm, maps.tainan_1875]
})
.addLayer(xdata)
.addControl(new L.Control.Scale)
.addControl(new L.Control.Layers({ '開放街圖': osm }, overlayMaps))
.on('zoomend', xapi)
.on('dragend', xapi);


function xapi(){
    $.ajax({
        // url: "http://open.mapquestapi.com/xapi/api/0.6/node[historic=*][bbox=" + map.getBounds().toBBoxString() + "]",
        url: "http://www.overpass-api.de/api/xapi?node[historic=*][bbox=" + map.getBounds().toBBoxString() + "]",
        dataType: "xml",
        success: function (xml) {
            map.removeLayer(xdata);
            xdata = new L.OSM.DataLayer(xml);
            map.addLayer(xdata);
        }
    });
}

xapi();
</script>
    </body>
</html>
